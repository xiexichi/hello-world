
<!-- 订单查找条件 -->
<include file="depot@base/order_where" />

<!-- 工具栏 -->
<script type="text/html" id="toolbar">
  <div class="layui-btn-group">
	  <!-- <button class="layui-btn layui-btn-primary layui-btn-sm" id="add-btn" title="新增进货单">
	    <i class="layui-icon">&#xe654;</i>
	  </button> -->
	  <button class="layui-btn layui-btn-primary layui-btn-sm" id="edit-btn" title="编辑进货单">
	    <i class="layui-icon">&#xe642;</i>
	  </button>
	  <button class="layui-btn layui-btn-primary layui-btn-sm" id="cancel-btn" title="作废进货单">
	    <i class="layui-icon">&#xe640;</i>
	  </button>
	</div>
</script> 

<!-- 進貨單表格 -->
<table id="list" lay-filter="list"></table>


<!-- 操作栏 -->
<script type="text/html" id="ctrlTpl">
  <div class="">
  	{{#  if(d.status == 0){ }}
	    <button class="layui-btn layui-btn-xs edit-order" order_id="{{ d.id }}">编辑商品项</button>
	{{#  } }} 

	{{#  if(d.status != 0){ }}
	    <button class="layui-btn layui-btn-disabled layui-btn-xs">编辑商品项</button>
	{{#  } }}
  </div>
</script>

<!-- 引入查找条件操作的js -->
<include file="depot@base/collapse_ctrl" />

<script type="text/javascript">

	// 选中的行
	var selectRow;

	// 时间对象
	var laydate = layui.laydate;

	// 开始时间
    laydate.render({
      elem: '#start-date', //指定元素
    });

    // 结束时间
    laydate.render({
      elem: '#end-date', //指定元素
    });


    // 表单提交
    var form = layui.form;
    form.on('submit(formDemo)', function(data){
	  // 重新获取表格数据
	  initTable(data.field);
	  return false;
	});

    
	// 初始化表格
	initTable();

	// 初始化表格
	function initTable(params){

	  var table = layui.table;

	  // 链接url
	  let url = '/depot/shop_differ_order/index?';

	  // 拼接参数
	  if (undefined !== params) {
		for (let i in params) {
		  if (params[i] !== '') {
		  	url += i + '=' + params[i] + '&';
		  }
		}	  	
	  }

	  //第一个实例
	  table.render({
	    elem: '#list'
	    ,height: tableNormalHeight + 'px'
	    ,url: url //数据接口
	    ,toolbar: '#toolbar'
	    // ,defaultToolbar: ['filter', 'print', 'exports']
	    ,page: true //开启分页
	    ,headers: {
	      ctrl: SHOP_DATA
	    }
	    ,done: function (res, curr, count) {
	    	// 表格初始化回调
			tableDoneCallBack();
	    }
	    ,cols: [[ //表头
	      {type: 'radio', fixed: 'left'}
	      ,{field: 'order_sn', title: '差异单号', width:180, sort: true}
	      ,{field: 'purchase_order_sn', title: '进货单号', width:180, sort: true}
	      ,{field: 'status_name', title: '状态', width:80}
	      ,{field: 'submit_time', title: '提交时间', width:180}
	      ,{field: 'create_time', title: '创建时间', width:180}
	      ,{field: 'apply_quantity', title: '差异数量', width:100}
	      ,{field: 'real_quantity', title: '调整数量', width:100}
	      ,{field: 'shop_name', title: '制单店铺', width:160}
	      ,{field: 'staff_name', title: '制单店员', width:120}
	      ,{field: 'shop_remark', title: '店铺备注', width:120} 
	      ,{field: 'platform_remark', title: '平台备注', width: 120}
	      ,{field: 'id', title: '操作', width: 120, templet: '#ctrlTpl'}
	    ]]
	  });

	  // 选中单选框
	  table.on('radio(list)', function(obj){

	    if (obj.checked) {
	      // 保存选中的行
	      selectRow = obj.data;
	    } else {
	      selectRow = null;	
	    }

	  });

	  //监听行双击事件
	  table.on('rowDouble(list)', function(obj){

	  	let url = '/depot/purchase/item_list.html?&is_differ=1&purchase_id='+obj.data.shop_purchase_order_id;
		//obj 同上
		// 打开进货单商品列表
		location.href = url;
	  });

	}


	/**
	 * [tableDoneCallBack 表格初始化完成后，回调方法]
	 * @return {[type]} [description]
	 */
	function tableDoneCallBack(){

		// 作废进货单
		$('#cancel-btn').on('click', function(){
			// 如果有选中行
			if (selectRow) {
				// 弹出确认框
				layer.confirm('确认要作废吗?作废后不能恢复的', function(index){
				  layer.close(index);

				  // 提交数据
				  request.post('/depot/shop_differ_order/cancel', {id: selectRow.id}, function(res){
				  	// 判断返回结果
				  	if (res.code == 0) {
				  		layer.alert('作废成功', function(index){
				  			// 关闭弹窗
				  			layer.close(index);
				  			// 刷新列表
				  			initTable();
				  		});
				  	} else {
				  		layer.alert(res.msg);
				  	}

				  });

				}); 
			}
		});

		// 修改订单
	    $('.edit-order').on('click', function(){
	    	let id = $(this).attr('order_id');
	    	// 打开进货单商品列表
			// openLayer('/depot/purchase/detail?id='+id, '进货单详情', {area: ['80%', '80%']});
			// 打开进货单商品列表
			location.href = '/depot/shop_differ/item_list?purchase_id='+id;
	    })

	    // 修改订单
	    $('#edit-btn').on('click', function(){
	    	// 打开进货单商品列表
			location.href = '/depot/shop_differ/detail?id='+selectRow.id;
	    })

	}


</script>