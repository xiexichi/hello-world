// layui
layui.use(['table', 'form', 'laydate'], function (){
  const table = layui.table
  const form = layui.form
  const laydate = layui.laydate

  form.render()

  //执行laydate实例
  laydate.render({
    elem: '#start_order_time'
  })
  laydate.render({
    elem: '#end_order_time'
  })

  // 数据表格
  table.render({
    elem: '#myDataTable',
    height: 'auto',
    url: '/order/order/index',
    limit: 20,
    toolbar: '#toolbarTpl',
    defaultToolbar: false,
    headers: {
      ctrl: SHOP_DATA
    },
    page: true,
    cols: [[
      {field: 'order_id', title: '', width:40, type:'radio'},
      {field: 'order_id', title: '#', width:30, type:'numbers'},
      {field: 'orderStatusDesc', title: '订单状态'},
      {field: 'order_type_desc', title: '订单类型'},
      {field: 'create_time', title: '下单时间', width:120},
      {field: 'pay_time', title: '支付时间', width:120},
      {field: 'order_sn', title: '订单号', width:160},
      {field: 'user_info', title: '会员名称', templet: function(d){
        return d.user_info.user_name
      }},
      {field: 'user_info', title: '手机号', templet: function(d){
        return d.user_info.phone
      }},
      {field: '--', title: '支付方式'},
      {field: 'pay_price', title: '实付金额'},
      {field: 'remark', title: '订单备注'},
      {field: '--', title: '业务员'},
      {field: 'order_id', title: '操作', width:100, templet: '#ctrlTpl'}
    ]]
  })

  //单击行选中radio事件
  $(document).on("click",".layui-table-body table.layui-table tbody tr", function () {
      var index = $(this).attr('data-index')
      var tableBox = $(this).parents('.layui-table-box')
      //存在固定列
      if (tableBox.find(".layui-table-fixed.layui-table-fixed-l").length>0) {
          tableDiv = tableBox.find(".layui-table-fixed.layui-table-fixed-l")
      } else {
          tableDiv = tableBox.find(".layui-table-body.layui-table-main")
      }
      var checkCell = tableDiv.find("tr[data-index=" + index + "]").find("td div.laytable-cell-radio div.layui-form-radio I")
      if (checkCell.length>0) {
          checkCell.click()
      }
  })
  $(document).on("click", "td div.laytable-cell-radio div.layui-form-radio", function (e) {
      e.stopPropagation()
  })


  //监听工具栏事件
  table.on ('toolbar(myDataTable)', function (obj) {
    const rows = table.checkStatus(obj.config.id)
    const data = rows.data[0] || undefined
    if (!data) {
      layer.msg('请选择要操作的行')
      return false
    }
    switch (obj.event){
      case 'cancel':
        layer.msg('作废')
        break
      case 'pay':
        layer.msg('支付')
        break
      case 'shipping':
        layer.msg('发货')
        break
      case 'erp':
        layer.msg('同步ERP')
        break
      case 'remark':
        layer.msg('备注')
        break
      case 'print':
        layer.msg('打印小票')
        break
    }
  })

  //监听行工具事件
  table.on('tool(myDataTable)', function (obj) {
    const loadlayer = layer.load()
    const data = obj.data
    const layEvent = obj.event
    const tr = obj.tr

    console.log(data)
    
    if (layEvent === 'detail') {
      layer.open({
        title: false,
        type: 2,
        area: ['900px', '85%'],
        shadeClose: true,
        content: '/order/index/detail?id=' + data.order_id
      })
      layer.close(loadlayer)
    }
  })

})